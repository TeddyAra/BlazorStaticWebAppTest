@page "/"
@using BlazorApp.Shared
@inject HttpClient Http

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

@if (logs == null)
{
    <p><em>Loading logs...</em></p>
} else if (logs.Length == 0)
{
    <p><em>No logs yet.</em></p>
} else
{
    <ul>
        @foreach (var log in logs)
        {
            <li>@log</li>
        }
    </ul>
}

@code {
    private string[] logs;
    private Timer? logRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await FetchLogsAsync();
        logRefreshTimer = new Timer(
            async _ => await InvokeAsync(FetchLogsAsync),
            null,
            TimeSpan.FromSeconds(5),
            TimeSpan.FromSeconds(5)
        );
    }

    private async Task FetchLogsAsync() 
    {
        try
        {
            logs = await Http.GetFromJsonAsync<string[]>("/api/webhook/logs") ?? Array.Empty<string>();
            foreach (var log in logs)
            {
                Console.WriteLine(log);
            }
        } catch (Exception ex)
        {
            Console.WriteLine("Error fetching logs: " + ex.Message);
            logs = Array.Empty<string>();
        }

        StateHasChanged();
    }

    public void Dispose()
    {
        logRefreshTimer?.Dispose();
    }
}